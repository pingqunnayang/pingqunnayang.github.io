---
layout: post
title:  细思惊喜
titlename: 细思惊喜
date:   2015-01-01 00:00:00 
category: 技术
tags: haproxy keepalived
description:
---

#### 1.Keepalived+Haproxy的实现原理初析

<p style="text-indent: 2em" />实现HA的方式，一般采用两台机器同时完成一项功能，比如数据库服务器，就是我们说的热备，当这台机器出现故障时，自动动态切换到另一台热备的机器。

`怎么实现故障检测？`

心跳，采用定时发送一个数据包，如果机器多长时间没响应，就认为是发生故障，自动切换到热备的机器上去。

`怎么实现自动切换？`

用虚IP，使用真实IP或者虚拟IP都能连接到机器，两个热备机器使用一个相同的虚拟IP，IP地址只是个逻辑地址，我们只需要把虚拟IP放入机器的ARP高速缓存就能实现虚拟IP。

>某台机器上的的ARP高速缓存 <br>
>10.24.1.219) at 01:2F:1A:2B:68:E6 [ether] on bond0 <br>
>(10.24.1.1.217) at 01:2F:1A:2B:68:E6 [ether] on bond0 <br>
>(10.24.1.218) at 00:21:5A:DB:7F:C2 [ether] on bond0 <br>

217和218是两台真实的机器，219是虚拟IP，可以看到219其实指向的是217这台机器，而当217机器出现异常时，我们需要切换到218的热备机器上，会发现ARP高速缓冲发生了变化

>10.24.1.219) at `00:21:5A:DB:7F:C2` [ether] on bond0<br>
>(10.24.1.1.217) at 01:2F:1A:2B:68:E6 [ether] on bond0<br>
>(10.24.1.218) at 00:21:5A:DB:7F:C2 [ether] on bond0<br>

可以发现虚拟IP219的物理地址指向了218机器，这样就实现了热备,所有发送到219的数据包都会发送到mac地址为00:21:5A:DB:7F:C2的机器。
