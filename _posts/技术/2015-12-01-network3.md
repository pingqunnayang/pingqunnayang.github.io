---
layout: post
title:  计算机网络学习三
titlename: 计算机网络学习三
date:   2015-12-01 13:48:53 
category: 技术
tags: network TCP IP
description:
---

###网络层

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。网络层不提供服务质量的承诺。
### 1. 网际协议IP
与IP层配套使用的四个协议：

- 地址解析协议ARP（Address Resoulution Protocol）
- 逆地址解析协议RARP （Reverse Address Resoulution Protocol）
- 网际控制报文协议ICMP（Internet Control Message Protocol）
- 网际组管理协议IGMP（Internet Group Management Protocol）

>网络互相连接起来要使用一些中间设备，根据中间设备所在层次可以分为：
> - 物理层使用的中间设备叫做转发器（repeater）。
> - 数据链路层使用的中间设备叫做网桥或桥接器（bridge）。
> - 网络层使用的中间设备叫做路由器。
> - 网络层以上使用的中间设备叫做网关（geteway）。

#### 1.1 分类的IP地址

`一个网络是指具有相同网络号net-id的主机的集合，网络层如何区分一个网络？`

<p style="text-indent: 2em">
一个IP地址在整个互联网范围内是唯一的，分类的IP就是将IP地址划分为若干固定类，每一类地址由两个固定长度的字段组成，其中一个字段是`网络号（net-id）`它标志主机（或路由）所连接到的网络。一个网络号在整个互联网范围内必须是唯一的。第二个字段是主机号（host-id），它标志该主机（或路由器），一个主机号在它前面的网络号所指明的网络范围内必须是唯一的。<br>

>IP地址 ::= {<网络号>,<主机号>}

![Alt text](/public/img/technology/network-7.png)

A类、B类和C类是单播地址，D类地址用于多播。从IP地址的结构可以看出，IP地址并不仅仅指明一个主机，而是还指明了主机所连接到的网络。
IP地址有以下有些重要特点：

1. 每一个IP地址都由网络号和主机号两部分组成。分两个等级的好处是：<br>
第一，IP地址管理机构在分配IP地址时只分配网络号，剩下的主机号由单位自行分配。<br>
第二，路由器器仅根据目的主机所连接的网络号来转发分组，这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间以及查找路由表的时间。
2. 实际上IP地址是标志一个主机（或路由器）和一条链路的接口，当一个主机同时连接到两个网络时，该主机必须同时具有两个相应的IP地址。
3. 一个网络是指具有相同网络号的主机集合，因此用转发器或网桥连接起来的若干个局域网必须仍然为一个网络。
4. 在IP地址中，所有分配到网络号的网络都是平等的。

> - 数据链路层使用的中间设备叫做网桥或桥接器（bridge）。
> - 网络层使用的中间设备叫做路由器。
> - 网络层以上使用的中间设备叫做网关（geteway）。

#### 1.2 IP地址与硬件地址
<p style="text-indent: 2em">物理地址是数据链路层和物理层使用地址，而IP地址是网络层和以上各层使用的地址，是一种逻辑地址，IP地址放在IP报的首部，而硬件地址放在MAC帧的首部。
Mac帧的首部在每次路由转发都会发生变化，这种变化IP层是无法看见的，虽然IP数据报首部有源站IP地址，但路由只根据目的站的IP地址的网络号进行路由选择。

`主机和路由怎么知道应当在MAC帧的首部填入什么样的硬件地址？`

`路由器中的路由表是怎么得出的？`

#### 1.3 地址解析协议ARP和逆地址解析协议RARP
<p style="text-indent: 2em">ARP就是解决通过IP地址查找物理地址，RARP就是通过物理地址查找IP地址，因为DHCP协议已经包含了RARP所以现在没有人使用单独的RARP。ARP解决这个问题的方法是在主机ARP高速缓存中存放一个IP地址到硬件地址的映射表，并且这个映射表还经常动态更新。

ARP请求步骤：

1. 当主机A向本局域网上的某个主机B发送IP数据报时，先在其ARP高速缓存中查看有无主机B的IP地址，如果有则把这个硬件地址写入MAC帧，如果查不到，主机A则主动运行ARP。

2. ARP进程在本局域网上广播发送一个ARP请求分组，在局域网上的所有主机上运行的ARP进程都能收到此ARP请求分组。

3. 主机B在ARP请求分组中见到自己的IP地址，就向主机A发送ARP响应分组，并写入自己的硬件地址。

4. 主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射。

如果要查找的主机不在同一个局域网，则需要通过路由来转发。从IP地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。

#### 1.4 IP数据报的格式

![Alt text](/public/img/technology/network-8.png)

<p style="text-indent: 2em">IP数据报由首部和数据两部分组成，首部的前一部分是固定长度共20各字节，后一部分是一些可选字段，其长度是可变的。

- 版本，IP协议的版本，通信双方使用的IP协议的版本必须一致。
- 首部长度。
- 区分服务，一般情况不使用这个字段。
- 总长度，指首部和数据之和的长度。
- 标识，IP软件在存储器中维持一个计数器，没产生一个数据报，计算器就加1，相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。
- 标志，标志是否还有分片。
- 片偏移，指出某片在原分组中的相对位置。
- 生存时间，TTL（time to live）表明数据报在网络中的寿命。
- 协议，使IP层知道应将数据上交给那个来处理。
- 首部检验和。
- 源地址。
- 目的地址。

#### 1.5 IP层转发分组的流程

<p style="text-indent: 2em">路由表是按网络地址来制作的，在互联网上转发分组，是从一个路由器转发到下一个路由器。在路由表中最主要的是以下两个信息：

>（目的网络地址，下一跳地址）

我们就根据目的网络地址来确定下一跳路由器，这样的结果是：

1. IP数据报最终一定可以找到目的主机所在目的网络上的路由器。
2. 只有到达最后一个路由器，才试图向目的主机进行直接交付。

`IP数据报的首部写上的IP地址是源地址和目的地址，没有中间经过的路由器IP地址，那么待转发的数据报又怎么能够找到下一跳的路由器呢？`

<p style="text-indent: 2em">当路由器收到一个待转发的数据报，在从路由表得到下一跳路由器的IP地址后，不是把这个地址填入IP数据报，而是送交下层的网络接口软件，网络接口软件负责把下一跳路由器的IP地址转换成硬件地址（使用ARP），并将此硬件地址放在链路层的MAC帧的首部，然后根据这个硬件地址找到下一跳路由器。由此可见，当发送一连串的数据报时，上述的这种查找路由表、计算硬件地址、写入MAC帧的首部等过程，将不断重复进行，造成了一定的开销。
### 2 划分子网和构造超网

####2.1 划分子网
<p style="text-indent: 2em">由于早期的IP地址设计不够合理，IP地址空间的利用率有时很低；给每一个物理网络分配一个网络号会使路由表变得太大因而是网络性能变坏；两级IP地址不够灵活，所有在IP地址中增加了一个**子网络字段**，使两级IP地址变成为三级IP地址，它能够较好地解决上述问题，这种做法叫做划分子网或子网寻址或子网路由选择。划分子网的方法是从网络的主机号借用若干位作为子网号subnet-id，表示法如下：

>IP地址  ::= {<网络号>，< 子网号>，<主机号>}

![Alt text](/public/img/technology/network-9.png)

`假定一个数据报其目的地址是145.13.3.10，已经到达了路由器R1，那么这个路由器如何把它转发到子网145.13.3.0？`

<p style="text-indent: 2em">从IP数据报的首部并不知道源主机或目的主机所连接的网络是否进行了子网划分，这是因为32位的IP地址本身以及数据报的首部都没有包含任何有关子网划分的信息，因此必须另外想办法，这就是使用子网掩码(subnet mask)。子网掩码是一个网络或一个子网的重要属性，在RFC 950成为因特网的正式标准后，路由器在和相邻路由器交换路由信息时，必须把自己所在网络的子网掩码告诉相邻路由器。

![Alt text](/public/img/technology/network-10.png)

####2.2 使用子网时分组转发

![Alt text](/public/img/technology/network-11.png))

1. 主机H1向H2发送分组的目的地址是H2的IP地址128.30.33.138，主机H1先把本子网的子网掩码"255.255.255.128"与H2的IP地址"128.30.33.138"逐位相"与"，得到"128.30.33.128",它不等于H1的网络地址，必须交给子网上的默认路由器R1转发。
2. R1路由逐行查询路由表，用目的IP地址与子网掩码进行相与，然后比较网络地址是否相同，当比较到第二行发现相同，于是R1把分组从接口1交付给主机H2。

#### 2.3 无分类编址CIDR（构造超网）
CIDR最主要的两个特点：

1. CIDR消除了传统的A类、B类和C类地址以及划分子网的概念。CIDR把32位的IP地址划分为两个部分，前面的部分是"网络前缀（network-prefix）"用来指明网络，后面的部分则用来指明主机。

>IP地址  ::= {<网络前缀>，<主机号>}

CIDR还使用"斜线记法"如128.14.35.7/20

2.CIDR把网络前缀都相同的连续IP地址组成一个"CIDR地址块"，我们只要知道地址块中一个地址，就可以知道这个地址块的起始地址和最大地址。

### 3 因特网路由的选择
####3.1 路由器
<p style="text-indent: 2em">因特网采用的路由选择协议主要是自适应的（即动态）、分布式路由选择协议。主要是两个原因，一是因为因特网的规模非常大，现在就有几百万个路由互连在一起，如果让所有的路由器知道所有的网络应怎么到达，则这种路由表将非常大，处理起来也太耗时，而所有这些路由之间交换路由信息所需的带宽会使因特网链路饱和，二是许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议。为此，因特网将整个互联网划分为许多较小的自治系统（autonomous system），一般记为AS，在目前因特网中，一个大的ISP就是一个自治系统，这样因特网就把路由选择协议划分为两大类：

1. 内部网关协议IGP（Interior Gateway Protocol）指在一个自治系统内部使用的路由选择协议。
2. 外部网关协议EGP(External Gateway Protocol) 

若源主机和目的主机处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。

#### 3.2 内部网关协议RIP

RIP协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录，RIP的特点：

1. 仅和相邻路由器交换信息。
2. 路由器交换信息是当前本路由器所知道的全部信息，即自己的路由表。
3. 按固定的时间间隔交换路由信息。

>RIP存在一个问题是当网络出现故障时，要经过比较长的时间才能将此消息传送到所有的路由器。因为会出现好消息传播最快，而坏消息传播得慢的情况。

RIP最大的优点就是实现简单，开销较小。但RIP协议的缺点也比较多，首先RIP限制了网络的规模，它能使用的最大距离为15，其次路由器之间交换的路由信息是路由器的完整路由表，随着网络规模的扩大，开销就增加。

#### 3.3 内部网关协议OSPF

<p style="text-indent: 2em">OSPF(Open Shortest Path First)开发最短路径优先。OSPF最主要的特征就是使用分布式的链路状态协议（link state protocol）而不是像RIP那样的距离向量协议，和RIP协议相比，OSPF的三个要点和RIP的都不一样。

1. 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法（flooding），这就是路由器通过所有输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再将此信息发往其所有的相邻路由器。
2. 发送的信息就是与本路由器相邻的所有路由器的链路状态，所谓"链路状态"就是说明本路由器都和那些路由器相邻，以及该链路的"度量（metric）"，OSPF将这个"度量"用来表示费用、距离、时延、带宽等等。
3. 只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息。而RIP协议不管网络拓扑有没有发送变化，都定期交换信息。 

![Alt text](/public/img/technology/network-11+1.png)

<p style="text-indent: 2em">OSPF能够用于规模很大的网络，OSPF将一个自治系统再划分为若干个更小的范围，叫作区域（area），划分区域的好处就是把利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个自治系统，这就减少了整个网络上的通信量。

<p style="text-indent: 2em">OSPF使用层次结构的区域划分。在上层的区域叫做主干区域，主干区域的标识符规定为0.0.0.0，主干区域的作用是用来连通其他下层区域。其他区域来的信息都由区域边界路由器进行概括，图中R3、R4、R5、R6、R7是主干路由器，R3、R4、R5是区域边界路由器。OSPF不用UDP而是直接用IP数据报传送。OSPF共有5中分组类型：

1. 问候（hello）分组，用来发现和维持邻站的可达性。
2. 数据库描述（Database Description）分组，向邻居站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
3. 链路状态请求（Link State Request）分组，向对方请求发送某些链路状态项目的详细信息。
4. 链路状态更新（Link State Update）分组，用洪泛法对全网更新链路状态。
5. 链路状态确认（Link State Acknowledgement）分组，对链路分组的确认。

#### 3.4 外部网关协议BGP

<p style="text-indent: 2em">BGP使用的环境与AS内部主要不同有两个原因：

1. 因特网的规模太大，使得AS之间理由选择非常困难。
2. AS之间的路由选择必须考虑有关策略，如AS的最短距离明显不符合BGP，因为部分国家可能处于安全考虑不想数据到国外兜圈子。

<p style="text-indent: 2em">由上述原因，边界网关协议BGP只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而非要寻找一条最佳路由。BGP采用了路径向量（path vector）路由选择协议，他与距离向量协议和链路状态协议都有很大的区别。
每个AS的管理员要选择至少一个路由器作为该AS的"BGP发言人"，一个BGP发言人与其他AS的BGP发言人要交换路由信息，就要先建立TCP连接（端口号为179），然后在此连接上交换BGP报文以建立BGP会话（session）。

![Alt text](/public/img/technology/network-12.png)

### 4 IP多播

<p style="text-indent: 2em">与单播相比，在一对多的通信中，多播可大大节约网络资源。图中视频服务器用单播方式向90个主机传送同样的视频节目，需要发送90个单播，而多播方式向属于同一个多播组的90个成员传送节目，只需要发送一次，路由器R1在转发分组时，需要把收到的分组复制成3个副本，当分组到达目的局域网时，由于局域网具有硬件多播功能，因此不需要复制分组。

![Alt text](/public/img/technology/network-13.png)

###5 虚拟专用网VPN和网络地址转换NAT
#### 5.1 虚拟专用网VPN
<p style="text-indent: 2em">VPN(Virtual Private Network)虚拟专用网之所以称为"专用网"是因为这种网络是为本机构的主机用于机构内部通讯，而不是用于和网络外非本机构的主机通信。如果专用网不同网店之间的通信必须经过公用的因特网，但又有加密的要求，那么所有通过因特网传送的数据都必须加密。

![Alt text](/public/img/technology/network-14.png)

<p style="text-indent: 2em">在一个场所A或B内部的通信都不经过因特网，但如果场所A的主机X要和另一个场所B的主机Y通信，那么就必须经过路由器R1和R2，主机X向主机Y发送的IP数据报的源地址是10.0.0.1而目的地址是10.2.0.3，当数据从X发送到因特网连接的路由器R1，路由器R1收到数据后发现必须经过因特网，就把整个内部数据报进行加密，然后重新加上数据报的首部，源地址125.1.2.3，目的地址194.4.5.6，路由器R2接收到数据报后将数据部分取出进行解密交付给主机Y。

#### 5.2 网络地址转换NAT
<p style="text-indent: 2em">网络地址转换NAT（Network Address Translation）是在路由器上安装NAT软件，然后将本地地址转换成全球IP地址，才能和因特网链接。

![Alt text](/public/img/technology/network-15.png)

<p style="text-indent: 2em">NAT的工作原理，专用网192.168.0.0内所有主机的IP地址都是本地IP地址192.168.x.x，NAT路由器至少要有一个全球IP地址，NAT路由器收到从专用网内部的主机A发往因特网上主机B的IP数据报，源地址是192.168.0.3，而目的IP地址是213.18.2.4，NAT路由器把IP数据报的源IP地址192.168.0.3转换成新的源IP地址172.38.1.5，然后转发出去。

![Alt text](/public/img/technology/network-16.png)

<p style="text-indent: 2em">为了更加有效地利用NAT路由器上的全球IP地址，现在常用的NAT转换表把运输层的端口号也利用上，这样就可以使多个拥有本地地址的主机共用一个NAT路由器上的全球IP地址。

![Alt text](/public/img/technology/network-17.png)













    



